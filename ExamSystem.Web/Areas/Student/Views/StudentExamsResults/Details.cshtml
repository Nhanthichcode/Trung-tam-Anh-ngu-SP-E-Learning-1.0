22@model ExamSystem.Core.Entities.TestAttempt
@using ExamSystem.Core.Enums
@{
    ViewData["Title"] = "Kết quả chi tiết";

    // 1. Thống kê số liệu
    int totalQ = Model.TestResults.Count;
    int correctQ = Model.TestResults.Count(x => x.IsCorrect == true);
    int wrongQ = Model.TestResults.Count(x => x.IsCorrect == false);
    // Những câu null là câu tự luận (Speaking/Writing) đang chờ chấm
    int pendingQ = Model.TestResults.Count(x => x.IsCorrect == null);

    // 2. Lấy danh sách kỹ năng & Sắp xếp theo thứ tự chuẩn
    var parts = Model.Exam.ExamParts.OrderBy(p => p.SkillType).ThenBy(p => p.OrderIndex).ToList();
    var skills = parts.Select(p => p.SkillType).Distinct().ToList();

    int globalIndex = 1;
}

<div class="container py-5">

    <div class="card shadow border-0 mb-5">
        <div class="card-body p-5">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 class="fw-bold text-primary mb-2">@Model.Exam.Title</h2>
                    <div class="text-muted mb-1">
                        <i class="bi bi-person-circle"></i> Thí sinh: <strong>@(Model.User?.FullName ?? "N/A")</strong>
                    </div>
                    <div class="text-muted">
                        <i class="bi bi-clock-history"></i> Nộp bài lúc:
                        @(Model.SubmitTime.HasValue? Model.SubmitTime.Value.ToString("dd/MM/yyyy HH:mm") : "--/--/----")
                    </div>
                </div>
                <div class="col-md-4 text-md-end text-center mt-3 mt-md-0">
                    <div class="display-4 fw-bold text-primary">@Model.Score <span class="fs-5 text-muted">điểm</span></div>
                    @if (pendingQ > 0)
                    {
                        <span class="badge bg-warning text-dark px-3 py-2 rounded-pill">
                            <i class="bi bi-hourglass-split"></i> Đang chờ chấm tự luận
                        </span>
                    }
                    else
                    {
                        <span class="badge bg-success px-3 py-2 rounded-pill">
                            <i class="bi bi-check-circle-fill"></i> Đã hoàn thành
                        </span>
                    }
                </div>
            </div>

            <hr class="my-4 opacity-10">

            <div class="row text-center">
                <div class="col-4 col-md-3">
                    <div class="p-3 bg-success bg-opacity-10 rounded-3">
                        <h3 class="fw-bold text-success mb-0">@correctQ</h3>
                        <small class="text-uppercase fw-bold text-success opacity-75">Đúng</small>
                    </div>
                </div>
                <div class="col-4 col-md-3">
                    <div class="p-3 bg-danger bg-opacity-10 rounded-3">
                        <h3 class="fw-bold text-danger mb-0">@wrongQ</h3>
                        <small class="text-uppercase fw-bold text-danger opacity-75">Sai</small>
                    </div>
                </div>
                <div class="col-4 col-md-3">
                    <div class="p-3 bg-warning bg-opacity-10 rounded-3">
                        <h3 class="fw-bold text-warning mb-0">@pendingQ</h3>
                        <small class="text-uppercase fw-bold text-warning opacity-75">Chờ chấm</small>
                    </div>
                </div>
                <div class="col-12 col-md-3 mt-3 mt-md-0">
                    <div class="p-3 bg-primary bg-opacity-10 rounded-3">
                        <h3 class="fw-bold text-primary mb-0">@totalQ</h3>
                        <small class="text-uppercase fw-bold text-primary opacity-75">Tổng câu</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (skills.Any())
    {
        <ul class="nav nav-pills nav-fill mb-4 p-2 bg-white rounded shadow-sm" id="resultTabs" role="tablist">
            @foreach (var skill in skills)
            {
                <li class="nav-item" role="presentation">
                    <button class="nav-link fw-bold rounded-pill @(skills.First() == skill ? "active" : "")"
                            id="tab-@skill" data-bs-toggle="pill" data-bs-target="#content-@skill" type="button">
                        @skill.ToString().ToUpper()
                    </button>
                </li>
            }
        </ul>

        <div class="tab-content">
            @foreach (var skill in skills)
            {
                <div class="tab-pane fade @(skills.First() == skill ? "show active" : "")" id="content-@skill">

                    @foreach (var part in parts.Where(p => p.SkillType == skill))
                    {
                        // Lấy các câu hỏi thuộc Part này và kết quả tương ứng
                        var partQIds = part.ExamQuestions.Select(eq => eq.QuestionId).ToList();
                        var results = Model.TestResults
                        .Where(r => partQIds.Contains(r.QuestionId))
                        // Sắp xếp lại cho đúng thứ tự trong đề
                        .OrderBy(r => partQIds.IndexOf(r.QuestionId))
                        .ToList();

                        if (!results.Any()) continue;

                        <div class="card mb-4 border-0 shadow-sm">
                            <div class="card-header bg-white py-3 border-bottom">
                                <h5 class="fw-bold m-0 text-primary"><i class="bi bi-bookmark-fill"></i> @part.Name</h5>
                            </div>
                            <div class="card-body">

                                @* --- LOGIC READING (Chia đôi màn hình) --- *@
                                @if (skill == ExamSkill.Reading)
                                {
                                    var passage = results.FirstOrDefault()?.Question?.ReadingPassage;
                                    <div class="row">
                                        <div class="col-lg-6 border-end" style="max-height: 70vh; overflow-y: auto;">
                                            @if (passage != null)
                                            {
                                                <div class="p-3 bg-light rounded">
                                                    <h5 class="fw-bold text-center mb-3">@passage.Title</h5>
                                                    <div class="text-justify" style="line-height: 1.8;">@Html.Raw(passage.Content)</div>
                                                </div>
                                            }
                                        </div>
                                        <div class="col-lg-6" style="max-height: 70vh; overflow-y: auto;">
                                            <div class="ps-lg-3">
                                                <div class="table-responsive">
                                                    @foreach (var r in results)
                                                    {
                                                        @RenderResultItem(r, globalIndex++)
                                                        ;
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    @* --- CÁC KỸ NĂNG KHÁC (Listening, Speaking, Writing) --- *@

                                    // 1. Hiển thị Audio chung của Part (nếu có) - dành cho Listening
                                    if (skill == ExamSkill.Listening)
                                    {
                                        var audio = results.FirstOrDefault()?.Question?.ListeningResource;
                                        if (audio != null)
                                        {
                                            <div class="alert alert-info mb-4 d-flex align-items-center">
                                                <i class="bi bi-volume-up-fill fs-3 me-3"></i>
                                                <div class="flex-grow-1">
                                                    <strong>Audio đề bài:</strong>
                                                    <audio controls class="w-100 mt-1"><source src="@audio.AudioUrl"></audio>
                                                </div>
                                            </div>
                                        }
                                    }

                                    // 2. Hiển thị danh sách câu hỏi
                                    foreach (var r in results)
                                    {

                                        @RenderResultItem(r, globalIndex++)
                                        ;
                                    }
                                }
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert alert-warning text-center">Không có dữ liệu bài thi.</div>
    }

    <div class="text-center mt-5 mb-5">
        <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary px-5 rounded-pill">
            <i class="bi bi-house-door-fill"></i> Quay về trang chủ
        </a>
    </div>
</div>

@* --- HÀM RENDER CHI TIẾT TỪNG CÂU --- *@
@{
    Microsoft.AspNetCore.Html.IHtmlContent RenderResultItem(ExamSystem.Core.Entities.TestResult r, int idx)
    {
        var sb = new System.IO.StringWriter();
        var q = r.Question;

        // Xác định trạng thái (Đúng/Sai/Chờ chấm)
        string statusBadge = "";
        string borderClass = "";
        string bgClass = "bg-white"; // Mặc định nền trắng

        if (r.IsCorrect == true)
        {
            statusBadge = "<span class='badge bg-success'><i class='bi bi-check-lg'></i> ĐÚNG</span>";
            borderClass = "border-success";
            bgClass = "bg-success bg-opacity-10"; // Nền xanh nhạt
        }
        else if (r.IsCorrect == false)
        {
            statusBadge = "<span class='badge bg-danger'><i class='bi bi-x-lg'></i> SAI</span>";
            borderClass = "border-danger";
            bgClass = "bg-danger bg-opacity-10"; // Nền đỏ nhạt
        }
        else
        {
            statusBadge = "<span class='badge bg-warning text-dark'><i class='bi bi-hourglass'></i> CHỜ CHẤM</span>";
            borderClass = "border-warning";
            bgClass = "bg-warning bg-opacity-10"; // Nền vàng nhạt
        }

        // Bắt đầu khung câu hỏi
        sb.Write($"<div class='mb-4 p-3 rounded border-start border-5 {borderClass} {bgClass} shadow-sm'>");

        // Header câu hỏi (Câu X + Trạng thái)
        sb.Write("<div class='d-flex justify-content-between align-items-start mb-2'>");
        sb.Write($"<h6 class='fw-bold text-dark m-0'>Câu {idx}:</h6>");
        sb.Write(statusBadge);
        sb.Write("</div>");

        // Nội dung câu hỏi
        sb.Write($"<div class='mb-3 fw-bold'>{q.Content}</div>");

        // Hiển thị ảnh câu hỏi (nếu có)
        if (!string.IsNullOrEmpty(q.MediaUrl))
        {
            sb.Write($"<div class='mb-3'><img src='{q.MediaUrl}' class='img-fluid rounded border' style='max-height: 250px;' /></div>");
        }

        // --- XỬ LÝ THEO LOẠI CÂU HỎI ---

        // 1. TRẮC NGHIỆM (Listening / Reading)
        if (q.SkillType != ExamSkill.Writing && q.SkillType != ExamSkill.Speaking)
        {
            if (q.Answers != null)
            {
                sb.Write("<div class='d-flex flex-column gap-2'>");
                foreach (var ans in q.Answers)
                {
                    string rowStyle = "border: 1px solid #dee2e6;";
                    string icon = "";
                    string badge = "";

                    // Logic tô màu đáp án
                    if (ans.IsCorrect == true)
                    {
                        rowStyle = "background-color: #d1e7dd; border-color: #badbcc; color: #0f5132; font-weight: bold;";
                        icon = "<i class='bi bi-check-circle-fill ms-auto text-success'></i>";
                    }

                    if (ans.Id == r.SelectedAnswerId)
                    {
                        badge = "<span class='badge bg-secondary ms-2'>Bạn chọn</span>";
                        if (!ans.IsCorrect == true)
                        {
                            rowStyle = "background-color: #f8d7da; border-color: #f5c2c7; color: #842029; font-weight: bold;"; // Chọn sai thì tô đỏ
                            icon = "<i class='bi bi-x-circle-fill ms-auto text-danger'></i>";
                        }
                    }

                    sb.Write($"<div class='p-2 rounded d-flex align-items-center' style='{rowStyle}'>");
                    sb.Write($"<span>{ans.Content}</span>");
                    sb.Write(badge);
                    sb.Write(icon);
                    sb.Write("</div>");
                }
                sb.Write("</div>");
            }
        }

        // 2. SPEAKING (GHI ÂM)
        else if (q.SkillType == ExamSkill.Speaking)
        {
            sb.Write("<div class='mt-3 pt-3 border-top border-secondary border-opacity-25'>");
            sb.Write("<h6 class='text-primary fw-bold mb-2'><i class='bi bi-mic'></i> Bài làm của bạn:</h6>");

            if (!string.IsNullOrEmpty(r.AudioAnswerUrl))
            {
                // Audio Player phát file .webm
                sb.Write($"<div class='bg-white p-2 rounded border d-flex align-items-center gap-2'>");
                sb.Write($"<audio controls class='w-100' style='height: 40px;'>");
                sb.Write($"<source src='{r.AudioAnswerUrl}' type='audio/webm'>"); // Ưu tiên Webm
                sb.Write($"<source src='{r.AudioAnswerUrl}' type='audio/mpeg'>"); // Fallback
                sb.Write("Trình duyệt không hỗ trợ phát file này.");
                sb.Write("</audio>");
                // Nút tải về
                sb.Write($"<a href='{r.AudioAnswerUrl}' download class='btn btn-outline-primary btn-sm' title='Tải về'><i class='bi bi-download'></i></a>");
                sb.Write("</div>");
            }
            else
            {
                sb.Write("<div class='alert alert-warning py-2 small'><i class='bi bi-exclamation-triangle'></i> Không tìm thấy bản ghi âm.</div>");
            }
            sb.Write("</div>");
        }

        // 3. WRITING (TỰ LUẬN)
        else if (q.SkillType == ExamSkill.Writing)
        {
            sb.Write("<div class='mt-3 pt-3 border-top border-secondary border-opacity-25'>");
            sb.Write("<h6 class='text-primary fw-bold mb-2'><i class='bi bi-pencil-square'></i> Bài làm của bạn:</h6>");
            sb.Write("<div class='p-3 bg-white border rounded text-dark' style='white-space: pre-wrap; font-family: monospace;'>");
            sb.Write(string.IsNullOrEmpty(r.TextAnswer) ? "<em class='text-muted'>(Bỏ trống)</em>" : r.TextAnswer);
            sb.Write("</div>");
            sb.Write("</div>");
        }

        // 4. FEEDBACK (Nếu có)
        if (!string.IsNullOrEmpty(r.Feedback))
        {
            sb.Write($"<div class='mt-3 alert alert-info mb-0 d-flex gap-2'>");
            sb.Write("<i class='bi bi-chat-quote-fill fs-4'></i>");
            sb.Write($"<div><strong>Giáo viên nhận xét:</strong><br/>{r.Feedback}</div>");
            sb.Write("</div>");
        }

        sb.Write("</div>"); // End .card
        return Html.Raw(sb.ToString());
    }
}