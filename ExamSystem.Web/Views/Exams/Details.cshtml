@model ExamSystem.Core.Entities.Exam
@using ExamSystem.Core.Enums

<div class="mt-4">
    <h4>Danh sách câu hỏi trong đề (@Model.ExamQuestions.Count câu)</h4>
    <hr />

    @if (Model.ExamQuestions.Count == 0)
    {
        <div class="alert alert-warning">
            Đề thi này chưa có câu hỏi nào.
            <a asp-action="AddQuestions" asp-route-id="@Model.Id">Soạn đề ngay</a>
        </div>
    }
    else
    {        
            // 1. Nhóm các câu hỏi theo Loại (Type)
            var questionsByType = Model.ExamQuestions
                .OrderBy(eq => eq.Question.Type) // Sắp xếp theo loại để nhóm
                .GroupBy(eq => eq.Question.Type)
                .ToDictionary(g => g.Key, g => g.ToList());

            // 2. Định nghĩa thứ tự ưu tiên hiển thị
            var displayOrder = new List<QuestionType> 
            { 
                QuestionType.ReadingPassage, 
                QuestionType.Listening, 
                QuestionType.Speaking, 
                QuestionType.Writing 
            };
            
            int globalIndex = 1; // Số thứ tự chung cho toàn bộ đề thi        

        @* Lặp qua thứ tự ưu tiên để đảm bảo Đọc -> Nghe -> Nói -> Viết *@
        @foreach (var type in displayOrder)
        {
            if (questionsByType.ContainsKey(type))
            {
                var currentGroup = questionsByType[type];
                string title = GetQuestionTypeTitle(type);
                string cssClass = GetTypeCssClass(type);
                
                <h5 class="mt-4 mb-2 p-2 @cssClass rounded">
                    <i class="fa @GetTypeIcon(type)"></i> @title (@currentGroup.Count câu)
                </h5>

                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-sm align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 5%">STT</th>
                                <th style="width: 55%">Nội dung câu hỏi / Bài đọc/Nghe</th>
                                <th style="width: 10%">Độ khó</th>
                                <th style="width: 10%">Điểm</th>
                                <th style="width: 20%">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in currentGroup.OrderBy(i => i.QuestionId)) // Sắp xếp theo ID Question để ổn định
                            {
                                <tr>
                                    <td class="text-center">@(globalIndex++)</td>
                                    <td>
                                        <div>@item.Question.Content</div>
                                        @if (item.Question.MediaUrl != null || item.Question.ListeningResource != null)
                                        {
                                            <small class="text-muted"><i class="fa fa-paperclip"></i> Có file đính kèm</small>
                                        }
                                        @if (item.Question.ReadingPassage != null)
                                        {
                                            <small class="text-muted"><i class="fa fa-book"></i> Thuộc Bài đọc</small>
                                        }
                                    </td>
                                    <td><span class="badge bg-secondary">Level @item.Question.Level</span></td>
                                    <td><span class="fw-bold text-success">@item.Score</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-danger" disabled title="Tính năng đang phát triển">Xóa khỏi đề</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        }
    }
</div>

@functions {
    // Helper function để lấy tên hiển thị
    public string GetQuestionTypeTitle(QuestionType type) => type switch
    {
        QuestionType.ReadingPassage => "Kỹ năng ĐỌC",
        QuestionType.Listening => "Kỹ năng NGHE",
        QuestionType.Speaking => "Kỹ năng NÓI",
        QuestionType.Writing => "Kỹ năng VIẾT",
        _ => "Khác"
    };

    // Helper function để lấy icon
    public string GetTypeIcon(QuestionType type) => type switch
    {
        QuestionType.ReadingPassage => "fa-book",
        QuestionType.Listening => "fa-headphones",
        QuestionType.Speaking => "fa-microphone",
        QuestionType.Writing => "fa-pencil",
        _ => "fa-question-circle"
    };

    // Helper function để lấy CSS Class
    public string GetTypeCssClass(QuestionType type) => type switch
    {
        QuestionType.ReadingPassage => "bg-warning bg-opacity-25 text-warning",
        QuestionType.Listening => "bg-info bg-opacity-25 text-info",
        QuestionType.Speaking => "bg-danger bg-opacity-25 text-danger",
        QuestionType.Writing => "bg-success bg-opacity-25 text-success",
        _ => "bg-secondary text-dark"
    };
}