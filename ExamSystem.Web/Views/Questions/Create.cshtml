@using ExamSystem.Core.Enums
@model ExamSystem.Web.Models.QuestionViewModel
@{
    ViewData["Title"] = "Tạo câu hỏi";
}

<div class="container mt-4">
    <div class="card border-primary shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="m-0"><i class="fa fa-plus-circle"></i> Tạo câu hỏi mới</h4>
            <a asp-action="Index" class="btn btn-sm btn-light text-primary fw-bold"><i class="fa fa-arrow-left"></i> Quay lại</a>
        </div>
        <div class="card-body">

            <div class="form-group mb-4 p-3 bg-light rounded border border-primary">
                <label class="fw-bold h5 text-primary"><i class="fa fa-filter"></i> Bước 1: Chọn kỹ năng thi</label>
                <select id="TypeSelector" class="form-select form-select-lg mt-2" asp-for="Type" asp-items="Html.GetEnumSelectList<QuestionType>()">
                    <option value="">-- Vui lòng chọn loại --</option>
                </select>
                <small class="text-muted" id="TypeHint">Chọn loại câu hỏi để hiển thị form nhập liệu tương ứng.</small>
            </div>

            @* ============================================== *@
            @* == FORM A: CÂU HỎI ĐƠN (NORMAL) == *@
            @* ============================================== *@
            <div id="FormNormal" style="display:none;">
                <form asp-action="Create" enctype="multipart/form-data">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    <input type="hidden" asp-for="Type" id="HiddenTypeNormal" />

                    <div class="row">
                        <div class="col-md-8">
                            <div class="card border-secondary mb-3">
                                <div class="card-header fw-bold bg-light">
                                    <i class="fa fa-pencil-square-o"></i> Nội dung chính
                                </div>
                                <div class="card-body">
                                    <div class="form-group mb-3">
                                        <label asp-for="Content" class="fw-bold" id="LabelContent">Nội dung câu hỏi <span class="text-danger">*</span></label>
                                        <textarea asp-for="Content" class="form-control" rows="4" placeholder="Nhập nội dung..."></textarea>
                                        <span asp-validation-for="Content" class="text-danger"></span>
                                    </div>

                                    <div class="card border-secondary mb-3" id="SectionOptions">
                                        <div class="card-header bg-secondary text-white fw-bold">
                                            <i class="fa fa-list"></i> Đáp án trắc nghiệm
                                        </div>
                                        <div class="card-body">
                                            <div class="row g-2">
                                                <div class="col-md-6"><div class="input-group"><span class="input-group-text fw-bold">A</span><input asp-for="OptionA" class="form-control" placeholder="Lựa chọn A" /></div></div>
                                                <div class="col-md-6"><div class="input-group"><span class="input-group-text fw-bold">B</span><input asp-for="OptionB" class="form-control" placeholder="Lựa chọn B" /></div></div>
                                                <div class="col-md-6"><div class="input-group"><span class="input-group-text fw-bold">C</span><input asp-for="OptionC" class="form-control" placeholder="Lựa chọn C" /></div></div>
                                                <div class="col-md-6"><div class="input-group"><span class="input-group-text fw-bold">D</span><input asp-for="OptionD" class="form-control" placeholder="Lựa chọn D" /></div></div>
                                            </div>
                                            <div class="row mt-3">
                                                <div class="col-md-4">
                                                    <label asp-for="CorrectAnswer" class="fw-bold">Đáp án đúng</label>
                                                    <select asp-for="CorrectAnswer" class="form-select text-success fw-bold">
                                                        <option value="">-- Chọn --</option>
                                                        <option value="A">A</option>
                                                        <option value="B">B</option>
                                                        <option value="C">C</option>
                                                        <option value="D">D</option>
                                                    </select>
                                                    <span asp-validation-for="CorrectAnswer" class="text-danger"></span>
                                                </div>
                                                <div class="col-md-8">
                                                    <label asp-for="Explaination" class="fw-bold">Giải thích đáp án</label>
                                                    <input asp-for="Explaination" class="form-control" placeholder="Hiện sau khi thi xong..." />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card bg-light mb-3" id="SectionMedia">
                                <div class="card-header fw-bold text-dark"><i class="fa fa-upload"></i> File đính kèm</div>
                                <div class="card-body">
                                    <p class="small text-muted mb-2" id="MediaHelpText">Upload Audio hoặc Hình ảnh.</p>
                                    <input asp-for="FileUpload" type="file" class="form-control" accept=".mp3,.wav,.jpg,.png,.jpeg" />
                                </div>
                            </div>

                            <div class="form-group mb-3">
                                <label asp-for="Level" class="fw-bold">Độ khó (Level)</label>
                                <select asp-for="Level" class="form-select">
                                    <option value="1">1 - Dễ (B1)</option>
                                    <option value="2">2 - Trung bình (B2)</option>
                                    <option value="3">3 - Khó (C1)</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="fw-bold">Gán Chủ đề</label>
                                <select asp-for="SelectedTopicIds" class="form-select" asp-items="ViewBag.Topics" multiple size="4"></select>
                                <small class="text-muted">Giữ phím Ctrl để chọn nhiều.</small>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-3 mb-5">
                        <button type="submit" class="btn btn-primary btn-lg px-5 shadow"><i class="fa fa-save"></i> LƯU CÂU HỎI ĐƠN</button>
                    </div>
                </form>
            </div>

            @* ============================================== *@
            @* == FORM B: CÂU HỎI NHÓM (GROUP) == *@
            @* ============================================== *@
            <div id="FormGroup" style="display:none;">
                <form asp-action="CreateGroupQuestion" method="post" id="GroupFormTag" onsubmit="return validateGroupForm(event)">
                    <input type="hidden" asp-for="Type" id="HiddenGroupType" />

                    <div class="row mb-3">
                        <div class="col-md-8">
                            <div id="SectionPassage" style="display:none;">
                                <label class="fw-bold text-success h5"><i class="fa fa-book"></i> Chọn Bài đọc từ Kho</label>
                                <select asp-for="ReadingPassageId" class="form-select border-success mb-2" asp-items="ViewBag.Passages">
                                    <option value="">-- Chọn bài đọc --</option>
                                </select>
                                <small><a href="/ReadingPassages/Create" target="_blank"><i class="fa fa-plus"></i> Tạo bài đọc mới</a></small>
                            </div>

                            <div id="SectionListening" style="display:none;">
                                <label class="fw-bold text-info h5"><i class="fa fa-headphones"></i> Chọn File nghe từ Kho</label>
                                <select asp-for="ListeningResourceId" class="form-select border-info mb-2" asp-items="ViewBag.Listenings">
                                    <option value="">-- Chọn bài nghe --</option>
                                </select>
                                <small><a href="/ListeningResources/Create" target="_blank"><i class="fa fa-plus"></i> Upload file nghe mới</a></small>
                            </div>

                            @* Thêm ô nhập liệu cho Transcript nếu chọn file nghe mới, hoặc nội dung bài đọc mới*@
                            <div class="form-group mt-3" id="SectionGroupText">
                                <label class="fw-bold" id="LabelGroupText">Nội dung Bài đọc/Transcript <span class="text-danger">*</span></label>
                                <textarea asp-for="PassageText" class="form-control" rows="8" placeholder="Dán nội dung bài đọc hoặc transcript vào đây..."></textarea>
                                <span class="text-muted small">Chỉ cần dán nội dung nếu bạn **chọn** tạo mới (hoặc không chọn file/bài đọc nào).</span>
                            </div>

                        </div>

                        <div class="col-md-4">
                            @* GÁN CHỦ ĐỀ VÀ LEVEL CHUNG *@
                            <div class="mb-3">
                                <label class="fw-bold">Gán Chủ đề</label>
                                <select asp-for="SelectedTopicIds" class="form-select" asp-items="ViewBag.Topics" multiple size="4"></select>
                            </div>

                            <label class="fw-bold">Độ khó chung</label>
                            <select asp-for="Level" class="form-select mb-3">
                                <option value="1">Level 1 (Dễ)</option>
                                <option value="2">Level 2</option>
                                <option value="3">Level 3</option>
                                <option value="4">Level 4</option>
                                <option value="5">Level 5 (Khó)</option>
                            </select>

                            <div class="alert alert-warning small">
                                <i class="fa fa-lightbulb-o"></i> <span id="GroupHint">Chọn Bài Đọc/Nghe trước khi thêm câu hỏi con.</span>
                            </div>
                        </div>
                    </div>

                    <hr />
                    <h5 class="text-primary mb-3">Danh sách câu hỏi trắc nghiệm</h5>

                    <div id="SubQuestionsContainer">
                        @* Cấu trúc câu hỏi con mặc định (Đã có trong code cũ) *@
                        <div class="card mb-3 sub-question-item shadow-sm border-0 bg-light border-start border-5 border-success">
                            <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                                <span>Câu hỏi số 1</span>
                                <button type="button" class="btn btn-sm btn-danger" onclick="questionEditor.removeRow(this)">Xóa</button>
                            </div>
                            <div class="card-body">
                                <div class="form-group mb-2">
                                    <label class="small text-muted fw-bold">Nội dung</label>
                                    <input name="SubQuestions[0].Content" class="form-control" placeholder="Nhập câu hỏi..." required />
                                </div>
                                <div class="row g-2">
                                    <div class="col-6"><input name="SubQuestions[0].OptionA" class="form-control form-control-sm" placeholder="A" required /></div>
                                    <div class="col-6"><input name="SubQuestions[0].OptionB" class="form-control form-control-sm" placeholder="B" required /></div>
                                    <div class="col-6"><input name="SubQuestions[0].OptionC" class="form-control form-control-sm" placeholder="C" required /></div>
                                    <div class="col-6"><input name="SubQuestions[0].OptionD" class="form-control form-control-sm" placeholder="D" required /></div>
                                </div>
                                <div class="mt-2 d-flex align-items-center">
                                    <span class="me-2 fw-bold">Đáp án đúng:</span>
                                    <select name="SubQuestions[0].CorrectAnswer" class="form-select form-select-sm w-auto fw-bold text-success">
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="C">C</option>
                                        <option value="D">D</option>
                                    </select>
                                </div>
                                <div class="mt-2">
                                    <input name="SubQuestions[0].Explaination" class="form-control form-control-sm" placeholder="Giải thích..." />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4 mb-5">
                        <button type="button" class="btn btn-outline-primary" onclick="questionEditor.addRow()">
                            <i class="fa fa-plus-circle"></i> Thêm câu hỏi
                        </button>
                        <button type="submit" class="btn btn-success btn-lg px-5 shadow">LƯU DỮ LIỆU</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/question-editor.js"></script>

    <script>
        // --- 1. HANDLE FORM SWITCHING ---
        document.getElementById('TypeSelector').addEventListener('change', function() {
            var val = this.value;

            // Areas
            var formNormal = document.getElementById('FormNormal');
            var formGroup = document.getElementById('FormGroup');
            var sectionPassage = document.getElementById('SectionPassage');
            var sectionListening = document.getElementById('SectionListening');
            var sectionOptions = document.getElementById('SectionOptions');
            var sectionMedia = document.getElementById('SectionMedia');
            var labelContent = document.getElementById('LabelContent');
            var mediaHelp = document.getElementById('MediaHelpText');
            var groupHint = document.getElementById('GroupHint');
            var sectionGroupText = document.getElementById('SectionGroupText');
            var labelGroupText = document.getElementById('LabelGroupText');
            var groupTypeSelector = document.getElementById('GroupFormTag');

            var hiddenTypeNormal = document.getElementById('HiddenTypeNormal');
            var hiddenGroupType = document.getElementById('HiddenGroupType');
            var typeSelector = document.getElementById('TypeSelector');

            // Reset Visibility
            if(formNormal) formNormal.style.display = 'none';
            if(formGroup) formGroup.style.display = 'none';
            if(sectionPassage) sectionPassage.style.display = 'none';
            if(sectionListening) sectionListening.style.display = 'none';
            if(sectionOptions) sectionOptions.style.display = 'block'; // Mặc định hiện cho Normal
            if(sectionMedia) sectionMedia.style.display = 'block'; // Mặc định hiện cho Normal
            if(sectionGroupText) sectionGroupText.style.display = 'none';


            if (val === "") {
                if(document.getElementById('TypeHint')) {
                     document.getElementById('TypeHint').innerText = "Chọn loại câu hỏi để hiển thị form nhập liệu tương ứng.";
                }
                return;
            }

            // --- LOGIC ---
            if (val == "5" || val == "3") { // Reading (5) or Listening (3) Group
                if(formGroup) formGroup.style.display = 'block';
                if(hiddenGroupType) hiddenGroupType.value = val;
                if(groupTypeSelector) groupTypeSelector.enctype = 'multipart/form-data';

                // Initialize Editor
                questionEditor.init(1, 'SubQuestionsContainer');

                if (val == "5") {
                    // READING
                    if(sectionPassage) sectionPassage.style.display = 'block';
                    if(sectionListening) sectionListening.style.display = 'none';
                    if(groupHint) groupHint.innerText = "Chọn bài đọc từ kho (hoặc dán nội dung mới). Sau đó thêm câu hỏi trắc nghiệm.";
                    if(sectionGroupText) sectionGroupText.style.display = 'block';
                    if(labelGroupText) labelGroupText.innerText = "Nội dung Bài đọc";
                } else {
                    // LISTENING
                    if(sectionPassage) sectionPassage.style.display = 'none';
                    if(sectionListening) sectionListening.style.display = 'block';
                    if(groupHint) groupHint.innerText = "Chọn file nghe từ kho (hoặc upload file nghe mới). Sau đó thêm câu hỏi liên quan.";
                    if(sectionGroupText) sectionGroupText.style.display = 'block';
                    if(labelGroupText) labelGroupText.innerText = "Transcript";
                }
            }
            else {
                // Normal Forms (Writing, Speaking, General)
                if(formNormal) formNormal.style.display = 'block';
                if(hiddenTypeNormal) hiddenTypeNormal.value = val;

                // Reset Options/Media status to default (General)
                if(sectionOptions) sectionOptions.style.display = 'block';
                if(sectionMedia) sectionMedia.style.display = 'block';

                if (val == "2") { // Writing
                    if(labelContent) labelContent.innerText = "Đề bài viết (Topic)";
                    if(sectionOptions) sectionOptions.style.display = 'none';
                    if(sectionMedia) sectionMedia.style.display = 'none';
                }
                else if (val == "4") { // Speaking
                    if(labelContent) labelContent.innerText = "Chủ đề nói (Prompt)";
                    if(sectionOptions) sectionOptions.style.display = 'none';
                    if(sectionMedia) sectionMedia.style.display = 'block';
                    if(mediaHelp) mediaHelp.innerText = "Upload hình ảnh gợi ý (nếu có).";
                }
                else { // General / Multiple Choice
                    if(labelContent) labelContent.innerText = "Nội dung câu hỏi";
                    if(mediaHelp) mediaHelp.innerText = "Upload file đính kèm (nếu có).";
                }
            }
        });

        // Initial setup on load
        document.addEventListener('DOMContentLoaded', function() {
            questionEditor.init(1, 'SubQuestionsContainer');

            var selector = document.getElementById('TypeSelector');
            if (selector && selector.value !== "") {
                 selector.dispatchEvent(new Event('change'));
            }
        });

        // --- 2. VALIDATION FOR GROUP FORM (Giữ nguyên) ---
        function validateGroupForm(event) {
            var type = document.getElementById('HiddenGroupType').value;

            // Validate Reading Selection
            if (type == "5") {
                var passageId = document.getElementById('ReadingPassageId').value;
                var passageText = document.getElementById('PassageText').value;
                // Nếu cả hai đều trống thì lỗi
                if (!passageId && !passageText) { alert("LỖI: Vui lòng chọn Bài đọc CÓ SẴN hoặc dán nội dung mới!"); return false; }
            }

            // Validate Listening Selection
            if (type == "3") {
                var audioId = document.getElementById('ListeningResourceId').value;
                // Nếu cả hai đều trống thì lỗi (Cần update Controller để kiểm tra FileUpload ở đây)
                if (!audioId) { alert("LỖI: Vui lòng chọn Bài nghe CÓ SẴN!"); return false; }
            }

            // Validate SubQuestions count
            var questions = document.querySelectorAll('.sub-question-item');
            if (questions.length === 0) { alert("LỖI: Phải có ít nhất 1 câu hỏi!"); return false; }

            // Re-index before submit
            questionEditor.validateForm();
            return true;
            }
                $('#ReadingPassageId').on('change', function () {
            var passageId = $(this).val();
            var contentArea = $('#PassageText');

            if (passageId) {
                // Gửi yêu cầu AJAX để lấy nội dung bài đọc
                $.ajax({
                    url: '/Questions/GetPassageContent',
                    type: 'GET',
                    data: { id: passageId },
                    success: function (result) {
                        // Điền nội dung vào textarea
                        contentArea.val(result.content);
                    },
                    error: function () {
                        contentArea.val('Lỗi: Không thể tải nội dung bài đọc.');
                    }
                });
            } else {
                // Nếu chọn '-- Chọn bài đọc --', xóa nội dung
                contentArea.val('');
            }
        });

        // Lắng nghe sự kiện thay đổi của Dropdown File nghe
        $('#ListeningResourceId').on('change', function () {
            var resourceId = $(this).val();
            var contentArea = $('#PassageText'); // Giả định Transcript dùng chung ID PassageText

            if (resourceId) {
                // Gửi yêu cầu AJAX để lấy nội dung nghe
                $.ajax({
                    url: '/Questions/GetListeningContent',
                    type: 'GET',
                    data: { id: resourceId },
                    success: function (result) {
                        // Điền Transcript vào textarea
                        contentArea.val(result.transcript);

                        // TÙY CHỌN: Hiển thị file nghe (Nếu cần)
                        // if (result.audioUrl) {
                        //    alert('File nghe: ' + result.audioUrl);
                        // }
                    },
                    error: function () {
                        contentArea.val('Lỗi: Không thể tải Transcript.');
                    }
                });
            } else {
                // Nếu chọn '-- Chọn bài nghe --', xóa nội dung
                contentArea.val('');
            }
        });        
    </script>
}