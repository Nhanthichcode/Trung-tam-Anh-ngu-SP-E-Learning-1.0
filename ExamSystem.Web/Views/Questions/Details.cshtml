@model ExamSystem.Core.Entities.Question
@using ExamSystem.Core.Enums

@{
    ViewData["Title"] = "Chi tiết câu hỏi";

    // Lấy danh sách đáp án đã chuẩn hóa (chỉ 4 cái đầu)
    var allAnswers = Model.Answers?.OrderBy(a => a.Id).Take(4).ToList();
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-primary"><i class="fa fa-info-circle"></i> Chi tiết câu hỏi #@Model.Id</h3>
        <div>
            <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning"><i class="fa fa-pencil"></i> Sửa</a>
            <a asp-action="Index" class="btn btn-secondary"><i class="fa fa-arrow-left"></i> Quay lại</a>
        </div>
    </div>

    <div class="card shadow-sm border-top-0 border-end-0 border-bottom-0 border-5 border-info">
        <div class="card-body">

            <div class="mb-3">
                <span class="badge bg-primary fs-6 me-2">@Model.Type</span>
                <span class="badge bg-dark fs-6 me-2">Level @Model.Level</span>
                <span class="text-muted small"><i class="fa fa-calendar"></i> Ngày tạo: @Model.CreatedDate.ToString("dd/MM/yyyy HH:mm")</span>
            </div>

            @* FIX 1: HIỂN THỊ BÀI ĐỌC TỪ ENTITY LIÊN KẾT *@
            @if (Model.Type == QuestionType.ReadingPassage && Model.ReadingPassage != null)
            {
                <div class="alert alert-success">
                    <h5 class="alert-heading fw-bold"><i class="fa fa-book"></i> Nội dung bài đọc (Passage):</h5>
                    <hr>
                    <div style="white-space: pre-wrap;">@Model.ReadingPassage.Content</div>
                </div>
            }

            <h4 class="card-title fw-bold text-dark mt-3">@Model.Content</h4>

            @* HIỂN THỊ MEDIA (Không thay đổi) *@
            @if (!string.IsNullOrEmpty(Model.MediaUrl))
            {
                <div class="my-3 p-3 bg-light rounded border">
                    <label class="fw-bold d-block mb-2"><i class="fa fa-paperclip"></i> File đính kèm:</label>
                    @if (Model.MediaUrl.EndsWith(".mp3") || Model.MediaUrl.EndsWith(".wav"))
                    {
                        <audio controls class="w-100">
                            <source src="@Model.MediaUrl">
                        </audio>
                    }
                    else if (Model.MediaUrl.EndsWith(".jpg") || Model.MediaUrl.EndsWith(".png") || Model.MediaUrl.EndsWith(".jpeg"))
                    {
                        <img src="@Model.MediaUrl" class="img-fluid rounded shadow-sm" style="max-height: 300px;" />
                    }
                    else
                    {
                        <a href="@Model.MediaUrl" target="_blank" class="btn btn-sm btn-outline-primary">Tải xuống file</a>
                    }
                </div>
            }

            <hr />

            @* FIX 2: HIỂN THỊ OPTIONS TỪ BẢNG ANSWERS *@
            @if (allAnswers != null && allAnswers.Any())
            {
                <h5 class="fw-bold text-secondary">Đáp án trắc nghiệm:</h5>
                <div class="row">
                    @for (int i = 0; i < allAnswers.Count; i++)
                    {
                        var answer = allAnswers[i];
                        var answerChar = ((char)('A' + i)).ToString(); // A, B, C, D
                        var isCorrect = answer.IsCorrect;

                        <div class="col-md-6 mb-3">
                            <ul class="list-group">
                                <li class="list-group-item @(isCorrect ? "list-group-item-success fw-bold" : "")">
                                    <span class="fw-bold me-2">@answerChar.</span> @answer.Content
                                    @if (isCorrect)
                                    {
                                        <i class="fa fa-check float-end text-success"></i>
                                    }
                                </li>
                            </ul>
                        </div>
                    }
                </div>
            }
            else if (Model.Type != QuestionType.ReadingPassage)
            {
                <div class="alert alert-info">Đây là câu hỏi @Model.Type và không có đáp án trắc nghiệm.</div>
            }

            @if (!string.IsNullOrEmpty(Model.Explaination))
            {
                <div class="alert alert-warning mt-3">
                    <strong><i class="fa fa-lightbulb-o"></i> Giải thích:</strong> @Model.Explaination
                </div>
            }
        </div>
    </div>
</div>