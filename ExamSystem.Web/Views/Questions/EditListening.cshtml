@model ExamSystem.Web.Models.QuestionViewModel

@{
    ViewData["Title"] = "Chỉnh sửa bài nghe";
}

<div class="container mt-4">
    <div class="card border-info shadow">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h4 class="m-0"><i class="fa fa-headphones"></i> Sửa bài nghe (Listening)</h4>
            <a asp-action="Index" class="btn btn-sm btn-light text-info fw-bold"><i class="fa fa-arrow-left"></i> Quay lại</a>
        </div>
        <div class="card-body">
            <form asp-action="EditListening" method="post" onsubmit="return questionEditor.validateForm()">
                <input type="hidden" asp-for="ListeningResourceId" />

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="fw-bold">File Audio hiện tại:</label>
                        <div class="p-3 bg-light border rounded text-center">
                            @if (!string.IsNullOrEmpty(ViewBag.AudioUrl))
                            {
                                <audio controls src="@ViewBag.AudioUrl" class="w-100"></audio>
                            }
                            else
                            {
                                <span class="text-danger">Không tìm thấy file audio.</span>
                            }
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="fw-bold">Transcript (Lời thoại)</label>
                        <textarea asp-for="Content" class="form-control" rows="3" placeholder="Sửa transcript..."></textarea>
                    </div>
                </div>

                <hr />
                <h5 class="text-primary">Danh sách câu hỏi</h5>

                <div id="SubQuestionsContainer">
                    @for (int i = 0; i < Model.SubQuestions.Count; i++)
                    {
                        <div class="card mb-3 sub-question-item shadow-sm bg-light">
                            <div class="card-header d-flex justify-content-between">
                                <span>Câu hỏi số @(i + 1)</span>
                                <input type="hidden" name="SubQuestions[@i].Id" value="@Model.SubQuestions[i].Id" />
                                <button type="button" class="btn btn-sm btn-danger" onclick="questionEditor.removeRow(this)">Xóa</button>
                            </div>
                            <div class="card-body">
                                <div class="mb-2"><input name="SubQuestions[@i].Content" value="@Model.SubQuestions[i].Content" class="form-control" required placeholder="Câu hỏi..." /></div>
                                <div class="row g-2">
                                    <div class="col-6"><input name="SubQuestions[@i].OptionA" value="@Model.SubQuestions[i].OptionA" class="form-control form-control-sm" placeholder="A" required /></div>
                                    <div class="col-6"><input name="SubQuestions[@i].OptionB" value="@Model.SubQuestions[i].OptionB" class="form-control form-control-sm" placeholder="B" required /></div>
                                    <div class="col-6"><input name="SubQuestions[@i].OptionC" value="@Model.SubQuestions[i].OptionC" class="form-control form-control-sm" placeholder="C" required /></div>
                                    <div class="col-6"><input name="SubQuestions[@i].OptionD" value="@Model.SubQuestions[i].OptionD" class="form-control form-control-sm" placeholder="D" required /></div>
                                </div>
                                <div class="mt-2 d-flex align-items-center">
                                    <span class="me-2 fw-bold">Đáp án đúng:</span>
                                    <select name="SubQuestions[@i].CorrectAnswer" class="form-select form-select-sm w-auto fw-bold text-success">
                                        @{
                                            var dbAns = Model.SubQuestions[i].CorrectAnswer?.ToUpper();
                                        }
                                        <option value="A" selected="@(dbAns == "A" ? "selected" : null)">A</option>
                                        <option value="B" selected="@(dbAns == "B" ? "selected" : null)">B</option>
                                        <option value="C" selected="@(dbAns == "C" ? "selected" : null)">C</option>
                                        <option value="D" selected="@(dbAns == "D" ? "selected" : null)">D</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <div class="d-flex justify-content-between mt-3">
                    <button type="button" class="btn btn-outline-primary" onclick="questionEditor.addRow()">Thêm câu hỏi</button>
                    <button type="submit" class="btn btn-info text-white btn-lg shadow">CẬP NHẬT</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script src="~/js/question-editor.js"></script>

    <script>
        // Khởi chạy script khi trang load xong
        document.addEventListener('DOMContentLoaded', function() {
            // Truyền vào số lượng câu hỏi hiện tại để biến đếm bắt đầu chính xác
            // Tham số 2 là ID của div chứa danh sách câu hỏi
            questionEditor.init(@Model.SubQuestions.Count, 'SubQuestionsContainer');
        });
    </script>
}