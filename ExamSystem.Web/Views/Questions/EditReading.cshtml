@model ExamSystem.Web.Models.QuestionViewModel

@{
    ViewData["Title"] = "Chỉnh sửa bài đọc";
}

<div class="container mt-4">
    <div class="card border-warning shadow">
        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
            <h4 class="m-0"><i class="fa fa-pencil-square-o"></i> Chỉnh sửa toàn bộ bài đọc</h4>
            <a asp-action="Index" class="btn btn-sm btn-dark"><i class="fa fa-arrow-left"></i> Hủy</a>
        </div>
        <div class="card-body">          
                <form asp-action="EditReading" method="post" onsubmit="return questionEditor.validateForm()">
                <div class="row mb-3">
                    <div class="col-md-9">
                        <label class="fw-bold text-success"><i class="fa fa-book"></i> Nội dung bài đọc (Sửa ở đây sẽ cập nhật cho tất cả câu hỏi)</label>
                        <textarea asp-for="PassageText" class="form-control border-success" rows="8" required></textarea>
                    </div>
                    <div class="col-md-3">
                        <label class="fw-bold">Độ khó chung</label>
                        <select asp-for="Level" class="form-select">
                            <option value="1">Dễ</option>
                            <option value="2">Vừa</option>
                            <option value="3">Khó</option>
                        </select>
                    </div>
                </div>

                <hr />
                <h5 class="text-primary mb-3">Danh sách câu hỏi chi tiết</h5>

                <div id="SubQuestionsContainer">
                    @for (int i = 0; i < Model.SubQuestions.Count; i++)
                    {
                        <div class="card mb-3 sub-question-item shadow-sm border-0 bg-light">
                            <div class="card-header bg-white fw-bold">
                                Câu hỏi số @(i + 1)
                                <input type="hidden" name="SubQuestions[@i].Id" value="@Model.SubQuestions[i].Id" />
                                <button type="button" class="btn btn-sm btn-danger" onclick="questionEditor.removeRow(this)">Xóa</button>
                            </div>
                            <div class="card-body">
                                <div class="form-group mb-2">
                                    <label class="small text-muted fw-bold">Nội dung</label>
                                    <input name="SubQuestions[@i].Content" value="@Model.SubQuestions[i].Content" class="form-control" required />
                                </div>
                                <div class="row g-2">
                                    <div class="col-6"><input name="SubQuestions[@i].OptionA" value="@Model.SubQuestions[i].OptionA" class="form-control form-control-sm" placeholder="A" required /></div>
                                    <div class="col-6"><input name="SubQuestions[@i].OptionB" value="@Model.SubQuestions[i].OptionB" class="form-control form-control-sm" placeholder="B" required /></div>
                                    <div class="col-6"><input name="SubQuestions[@i].OptionC" value="@Model.SubQuestions[i].OptionC" class="form-control form-control-sm" placeholder="C" required /></div>
                                    <div class="col-6"><input name="SubQuestions[@i].OptionD" value="@Model.SubQuestions[i].OptionD" class="form-control form-control-sm" placeholder="D" required /></div>
                                </div>
                                <div class="row mt-2 align-items-center">
                                    <div class="col-auto"><span class="small fw-bold">Đáp án đúng:</span></div>
                                    <select name="SubQuestions[@i].CorrectAnswer"
                                            class="form-select form-select-sm fw-bold text-success border-success"
                                            style="width: 80px;" required>

                                        @{
                                            // Chuẩn hóa đáp án từ DB: Viết hoa và cắt khoảng trắng để so sánh chính xác
                                            var dbAnswer = Model.SubQuestions[i].CorrectAnswer?.Trim().ToUpper();
                                        }

                                        <option value="A" selected="@(dbAnswer == "A" ? "selected" : null)">A</option>
                                        <option value="B" selected="@(dbAnswer == "B" ? "selected" : null)">B</option>
                                        <option value="C" selected="@(dbAnswer == "C" ? "selected" : null)">C</option>
                                        <option value="D" selected="@(dbAnswer == "D" ? "selected" : null)">D</option>
                                    </select>
                                    <div class="col"><input name="SubQuestions[@i].Explaination" value="@Model.SubQuestions[i].Explaination" class="form-control form-control-sm" placeholder="Giải thích..." /></div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-outline-primary" onclick="questionEditor.addRow()">Thêm câu hỏi</button>
                    <button type="submit" class="btn btn-warning btn-lg px-5 shadow">
                        <i class="fa fa-save"></i> CẬP NHẬT TẤT CẢ
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script src="~/js/question-editor.js"></script>

    <script>
        // Khởi chạy script khi trang load xong
        document.addEventListener('DOMContentLoaded', function() {
            // Truyền vào số lượng câu hỏi hiện tại để biến đếm bắt đầu chính xác
            // Tham số 2 là ID của div chứa danh sách câu hỏi
            questionEditor.init(@Model.SubQuestions.Count, 'SubQuestionsContainer');
        });
    </script>
}