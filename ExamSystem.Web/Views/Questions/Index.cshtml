@model IEnumerable<ExamSystem.Core.Entities.Question>
@using ExamSystem.Core.Enums

@{
    ViewData["Title"] = "Ngân hàng Câu hỏi";

    // Lấy dữ liệu lọc để giữ trạng thái Form
    var currentFilter = ViewData["CurrentFilter"] as string;
    var currentType = ViewData["CurrentType"];
    var currentLevel = ViewData["CurrentLevel"];
    var currentTopicId = ViewData["CurrentTopicId"];

    // Phân loại dữ liệu cho từng Tab
    // Lưu ý: Dữ liệu Model đã được lọc từ Controller, ta chỉ chia nhóm theo Type để hiển thị vào Tab
    var readingQuestions = Model.Where(q => q.Type == QuestionType.ReadingPassage || q.ReadingPassageId.HasValue).ToList();
    var listeningQuestions = Model.Where(q => q.Type == QuestionType.Listening || q.ListeningResourceId.HasValue).ToList();
    var speakingQuestions = Model.Where(q => q.Type == QuestionType.Speaking).ToList();
    var writingQuestions = Model.Where(q => q.Type == QuestionType.Writing).ToList();    
}

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="text-primary"><i class="fa fa-university"></i> Ngân hàng Câu hỏi</h2>
        <a asp-action="Create" class="btn btn-success shadow-sm">
            <i class="fa fa-plus-circle"></i> Tạo mới
        </a>
    </div>

    @* === FORM LỌC === *@
    <form asp-action="Index" method="get" class="mb-4 p-3 bg-light rounded shadow-sm">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label fw-bold small">Tìm kiếm</label>
                <input type="text" name="searchString" value="@currentFilter" class="form-control form-control-sm" placeholder="Nhập từ khóa..." />
            </div>
            <div class="col-md-2">
                <label class="form-label fw-bold small">Loại</label>
                <select name="filterType" class="form-select form-select-sm" asp-items="ViewBag.QuestionTypes">
                    <option value="">-- Tất cả --</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label fw-bold small">Độ khó</label>
                <select name="filterLevel" class="form-select form-select-sm" asp-items="@ViewData[" Levels"] as SelectList">
                    <option value="">-- Tất cả --</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold small">Chủ đề</label>
                <select name="filterTopicId" class="form-select form-select-sm" asp-items="@ViewData[" Topics"] as SelectList">
                    <option value="">-- Tất cả --</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100 btn-sm"><i class="fa fa-filter"></i> Lọc</button>
            </div>
        </div>
    </form>

    @* === TABS NAVIGATION === *@
    <ul class="nav nav-tabs" id="questionBankTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active fw-bold text-warning" id="reading-tab" data-bs-toggle="tab" data-bs-target="#reading" type="button" role="tab">
                <i class="fa fa-book"></i> ĐỌC (@readingQuestions.Count)
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold text-info" id="listening-tab" data-bs-toggle="tab" data-bs-target="#listening" type="button" role="tab">
                <i class="fa fa-headphones"></i> NGHE (@listeningQuestions.Count)
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold text-danger" id="speaking-tab" data-bs-toggle="tab" data-bs-target="#speaking" type="button" role="tab">
                <i class="fa fa-microphone"></i> NÓI (@speakingQuestions.Count)
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold text-success" id="writing-tab" data-bs-toggle="tab" data-bs-target="#writing" type="button" role="tab">
                <i class="fa fa-pencil"></i> VIẾT (@writingQuestions.Count)
            </button>
        </li>       
    </ul>

    @* === TABS CONTENT (Gọi Partial View) === *@
    <div class="tab-content border border-top-0 p-3 bg-white shadow-sm rounded-bottom" id="myTabContent">
        <div class="tab-pane fade show active" id="reading" role="tabpanel">
            <partial name="_QuestionListPartial" model="readingQuestions" />
        </div>
        <div class="tab-pane fade" id="listening" role="tabpanel">
            <partial name="_QuestionListPartial" model="listeningQuestions" />
        </div>
        <div class="tab-pane fade" id="speaking" role="tabpanel">
            <partial name="_QuestionListPartial" model="speakingQuestions" />
        </div>
        <div class="tab-pane fade" id="writing" role="tabpanel">
            <partial name="_QuestionListPartial" model="writingQuestions" />
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // --- 1. Giữ giá trị bộ lọc ---
            var currentLevel = "@(currentLevel?.ToString() ?? "")";
            var currentTopicId = "@(currentTopicId?.ToString() ?? "")";
            var currentType = "@(currentType?.ToString() ?? "")";

            if (currentLevel) $('select[name="filterLevel"]').val(currentLevel);
            if (currentTopicId) $('select[name="filterTopicId"]').val(currentTopicId);

            // --- 2. Logic giữ Tab Active ---
            var activeTab = localStorage.getItem('activeBankTab');
            let initialTabId = 'reading-tab';

            // Nếu người dùng lọc theo Type cụ thể, ưu tiên mở Tab đó
            if (currentType) {
                let typeVal = parseInt(currentType);
                if (typeVal === 3) initialTabId = 'reading-tab';      // Reading
                else if (typeVal === 4) initialTabId = 'listening-tab'; // Listening
                else if (typeVal === 5) initialTabId = 'speaking-tab';  // Speaking
                else if (typeVal === 6) initialTabId = 'writing-tab';   // Writing
                else initialTabId = 'general-tab';
            }
            else if (activeTab) {
                initialTabId = activeTab + '-tab';
            }

            // Kích hoạt Tab
            var triggerEl = document.getElementById(initialTabId);
            if (triggerEl) {
                new bootstrap.Tab(triggerEl).show();
            } else {
                new bootstrap.Tab(document.getElementById('reading-tab')).show();
            }

            // Lưu lại Tab khi click
            var tabEl = document.querySelectorAll('button[data-bs-toggle="tab"]');
            tabEl.forEach(function(tab) {
                tab.addEventListener('shown.bs.tab', function (event) {
                    localStorage.setItem('activeBankTab', event.target.id.replace('-tab', ''));
                });
            });
        });
    </script>
}