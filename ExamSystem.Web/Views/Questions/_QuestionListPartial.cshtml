@model IEnumerable<ExamSystem.Core.Entities.Question>
@using ExamSystem.Core.Enums

@{
    if (Model == null || !Model.Any())
    {
        <div class="text-center py-5 text-muted bg-light rounded border border-dashed">
            <i class="fa fa-folder-open-o fa-3x mb-3 text-secondary"></i><br />
            <span class="fw-bold">Không tìm thấy dữ liệu phù hợp.</span>
        </div>
        return;
    }

    // Gom nhóm dữ liệu
    var groupedItems = Model
        .OrderByDescending(q => q.CreatedDate)
        .GroupBy(q => new
        {
            // Lấy ID cha (ReadingPassageId/ListeningResourceId) nếu có, nếu không thì lấy ID câu hỏi
            ParentId = q.ReadingPassageId.HasValue || q.ListeningResourceId.HasValue
                       ? (q.ReadingPassageId ?? q.ListeningResourceId).ToString()
                       : q.Id.ToString(),
            q.Type
        })
        .ToList();

    int stt = 1;
}

<div class="table-responsive shadow-sm" style="max-height: 65vh; overflow-y: auto;">
    <table class="table table-hover align-middle mb-0 border">
        <thead class="bg-dark text-white sticky-top">
            <tr>
                <th style="width: 5%" class="text-center">STT</th>
                <th style="width: 50%">Nội dung câu hỏi / Bài gốc</th>
                <th style="width: 15%">Loại</th>
                <th style="width: 10%" class="text-center">Độ khó</th>
                <th style="width: 10%">Chủ đề</th>
                <th style="width: 10%" class="text-center">Thao tác</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var group in groupedItems)
            {
                var firstItem = group.First();
                // Xác định đây có phải là nhóm Bài đọc/Nghe không
                bool isGrouped = group.Count() > 1
                || firstItem.Type == QuestionType.ReadingPassage
                || (firstItem.Type == QuestionType.Listening && firstItem.ListeningResource != null);

                // --- XÁC ĐỊNH ACTION LINK VÀ ID CHÍNH ---
                string editAction = "Edit";
                string detailsAction = "Details";
                string deleteAction = "Delete"; // Mặc định là xóa câu hỏi

                // QUAN TRỌNG: Xác định ID dùng cho link
                // Nếu là nhóm, ta dùng ParentId (ID bài đọc/nghe). Nếu lẻ, dùng ID câu hỏi.
                string linkId = isGrouped ? group.Key.ParentId : firstItem.Id.ToString();

                switch (firstItem.Type)
                {
                    case QuestionType.ReadingPassage:
                        editAction = "EditReading";
                        detailsAction = "DetailsReading";
                        break;
                    case QuestionType.Listening:
                        editAction = "EditListening";
                        detailsAction = "DetailsListening";
                        break;
                    case QuestionType.Speaking:
                        editAction = "EditSpeaking";
                        detailsAction = "DetailsSpeaking";
                        break;
                    case QuestionType.Writing:
                        editAction = "EditWriting";
                        detailsAction = "DetailsWriting";
                        break;
                    default:
                        editAction = "Edit";
                        detailsAction = "Details";
                        break;
                }

                // --- HÀNG TIÊU ĐỀ NHÓM (Dành cho Bài đọc/Nghe) ---
                if (isGrouped)
                {
                    string parentTitle = "Nhóm câu hỏi";
                    string parentContent = "";
                    string iconClass = "fa-folder";
                    string bgClass = "table-secondary";

                    string collapseId = "collapse_" + group.Key.ParentId + "_" + firstItem.Type;

                    if (firstItem.Type == QuestionType.ReadingPassage && firstItem.ReadingPassage != null)
                    {
                        parentTitle = firstItem.ReadingPassage.Title;
                        parentContent = firstItem.ReadingPassage.Content;
                        iconClass = "fa-book text-warning";
                        bgClass = "table-warning bg-opacity-10";
                    }
                    else if (firstItem.Type == QuestionType.Listening && firstItem.ListeningResource != null)
                    {
                        parentTitle = firstItem.ListeningResource.Title;
                        parentContent = "Audio Source: " + firstItem.ListeningResource.AudioUrl;
                        iconClass = "fa-headphones text-info";
                        bgClass = "table-info bg-opacity-10";
                    }

                    if (!string.IsNullOrEmpty(parentContent) && parentContent.Length > 100)
                    {
                        parentContent = parentContent.Substring(0, 100) + "...";
                    }

                    // --- HÀNG CHA: NÚT THAO TÁC SỬ DỤNG 'linkId' (ID BÀI GỐC) ---
                    <tr class="@bgClass fw-bold border-bottom border-secondary">
                        <td class="text-center"><span class="badge bg-dark rounded-pill">#G</span></td>
                        <td colspan="4">
                            <div class="d-flex align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#@collapseId" aria-expanded="true" aria-controls="@collapseId">
                                <i class="fa @iconClass me-2"></i>
                                <span class="me-2">@parentTitle</span>
                                <span class="badge bg-secondary ms-2">@group.Count() câu hỏi</span>
                                <i class="fa fa-chevron-down ms-auto text-muted"></i>
                            </div>
                            <div class="small text-muted fw-normal fst-italic ms-4 collapse show" id="@(collapseId)_summary">
                                @parentContent
                            </div>
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm bg-white rounded shadow-sm">
                                @* FIX: Sử dụng linkId (ID bài đọc/nghe) thay vì firstItem.Id *@
                                <a href="/Questions/@editAction/@linkId" class="btn btn-outline-warning" title="Sửa nhóm"><i class="fa fa-pencil"></i></a>
                                <a href="/Questions/@detailsAction/@linkId" class="btn btn-outline-info" title="Xem chi tiết"><i class="fa fa-eye"></i></a>

                                @* Nút Xóa có thể cần logic riêng nếu muốn xóa cả bài đọc, tạm thời trỏ về Delete thường hoặc DeleteResource *@
                                @* Lưu ý: Nếu xóa Bài đọc, cần xóa trong bảng ReadingPassages *@
                                @if (firstItem.Type == QuestionType.ReadingPassage)
                                {
                                    // Bạn có thể cần tạo Action DeleteReading trong Controller nếu chưa có
                                    <a href="#" class="btn btn-outline-danger disabled" title="Xóa cả bài đọc (Chưa hỗ trợ)"><i class="fa fa-trash"></i></a>
                                }
                                else
                                {
                                    <a href="/Questions/Delete/@firstItem.Id" class="btn btn-outline-danger" title="Xóa câu đầu tiên"><i class="fa fa-trash"></i></a>
                                }
                            </div>
                        </td>
                    </tr>

                    // --- VÒNG LẶP CÂU HỎI CON ---
                    foreach (var item in group.OrderBy(q => q.Id))
                    {
                        string indentClass = "ps-5 border-start border-3 border-warning";
                        string collapseClass = "collapse show bg-white";
                        string collapseDataId = collapseId;

                        string contentDisplay = item.Content;
                        string mediaDisplay = "";
                        if (!string.IsNullOrEmpty(item.MediaUrl))
                        {
                            mediaDisplay = $"<div class='small text-muted mt-1'><i class='fa fa-picture-o'></i> {System.IO.Path.GetFileName(item.MediaUrl)}</div>";
                        }

                        string topicDisplay = "---";
                        if (item.QuestionTopics != null && item.QuestionTopics.Any())
                        {
                            topicDisplay = item.QuestionTopics.First().Topic?.Name;
                            if (item.QuestionTopics.Count > 1) topicDisplay += $" (+{item.QuestionTopics.Count - 1})";
                        }

                        <tr class="@collapseClass" id="@collapseDataId">
                            <td class="text-center text-muted">@stt</td>
                            <td class="@indentClass">
                                <i class="fa fa-level-up fa-rotate-90 text-muted me-2"></i>
                                <span class="text-dark">@contentDisplay</span>
                                @Html.Raw(mediaDisplay)
                            </td>
                            <td></td>
                            <td class="text-center"><span class="badge bg-light text-dark border">Lv @item.Level</span></td>
                            <td><span class="small text-secondary">@topicDisplay</span></td>
                            <td class="text-center">
                                <span class="text-muted small fst-italic">Chi tiết trong nhóm</span>
                            </td>
                        </tr>
                        stt++;
                    }
                }
                else
                {
                    // --- HÀNG ĐƠN LẺ (Speaking/Writing hoặc câu hỏi rời) ---
                    foreach (var item in group)
                    {
                        // Với câu hỏi đơn, linkId chính là item.Id
                        string curEditAction = editAction;
                        string curDetailAction = detailsAction;

                        string topicDisplay = "---";
                        if (item.QuestionTopics != null && item.QuestionTopics.Any())
                        {
                            topicDisplay = item.QuestionTopics.First().Topic?.Name;
                        }

                        <tr>
                            <td class="text-center text-muted">@stt</td>
                            <td>
                                <span class="text-dark">@item.Content</span>
                                @if (!string.IsNullOrEmpty(item.MediaUrl))
                                {
                                    <div class='small text-muted mt-1'><i class='fa fa-picture-o'></i> File</div>
                                }
                            </td>
                            <td><span class="badge bg-@GetColor(item.Type)">@GetName(item.Type)</span></td>
                            <td class="text-center"><span class="badge bg-light text-dark border">Lv @item.Level</span></td>
                            <td><span class="small text-secondary">@topicDisplay</span></td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm">
                                    <a href="/Questions/@curEditAction/@item.Id" class="btn btn-light border text-warning" title="Sửa"><i class="fa fa-pencil"></i></a>
                                    <a href="/Questions/@curDetailAction/@item.Id" class="btn btn-light border text-info" title="Xem"><i class="fa fa-eye"></i></a>
                                    <a href="/Questions/Delete/@item.Id" class="btn btn-light border text-danger" title="Xóa"><i class="fa fa-trash"></i></a>
                                </div>
                            </td>
                        </tr>
                        stt++;
                    }
                }
            }
        </tbody>
    </table>
</div>

@functions {
    public string GetName(QuestionType t) => t switch
    {
        QuestionType.ReadingPassage => "ĐỌC",
        QuestionType.Listening => "NGHE",
        QuestionType.Speaking => "NÓI",
        QuestionType.Writing => "VIẾT",
        _ => "Khác"
    };
    public string GetColor(QuestionType t) => t switch
    {
        QuestionType.ReadingPassage => "warning",
        QuestionType.Listening => "info",
        QuestionType.Speaking => "danger",
        QuestionType.Writing => "success",
        _ => "secondary"
    };
}