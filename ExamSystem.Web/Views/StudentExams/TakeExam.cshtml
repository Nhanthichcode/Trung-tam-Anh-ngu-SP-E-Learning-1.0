@model List<ExamSystem.Core.Entities.Question>
@using ExamSystem.Core.Enums

@{
    ViewData["Title"] = "Làm bài thi";

    // --- 1. PHÂN LOẠI DỮ LIỆU ---

    // Phần ĐỌC: Gom nhóm theo Bài đọc
    var readingData = Model.Where(x => x.Type == QuestionType.ReadingPassage)
        .GroupBy(x => x.ReadingPassageId)
        .ToList();

    // Phần NGHE: Gom nhóm theo File nghe
    var listeningData = Model.Where(x => x.Type == QuestionType.Listening && x.ListeningResourceId.HasValue)
        .GroupBy(x => x.ListeningResourceId)
        .ToList();

    // Phần NÓI: Lấy danh sách câu hỏi nói
    var speakingData = Model.Where(x => x.Type == QuestionType.Speaking).ToList();

    // Phần VIẾT: Lấy danh sách câu hỏi viết
    var writingData = Model.Where(x => x.Type == QuestionType.Writing).ToList();

    // Biến đếm số thứ tự câu hỏi toàn bài
    int globalStt = 0;
}

<div class="container-fluid mt-3">
    @* HEADER: TIÊU ĐỀ & ĐỒNG HỒ *@
    <div class="card shadow-sm mb-3 sticky-top" style="z-index: 1000;">
        <div class="card-body py-2 d-flex justify-content-between align-items-center">
            <h4 class="text-primary m-0 fw-bold"><i class="fa fa-graduation-cap"></i> @ViewBag.ExamTitle</h4>
            <div class="d-flex align-items-center">
                <span class="text-muted me-2">Thời gian còn lại:</span>
                <span class="badge bg-danger fs-5" id="timer">@ViewBag.Duration:00</span>
            </div>
        </div>
    </div>

    <form asp-action="SubmitExam" method="post" id="examForm">
        <input type="hidden" name="examId" value="@ViewBag.ExamId" />

        @* --- THANH ĐIỀU HƯỚNG (TABS) --- *@
        <ul class="nav nav-tabs nav-fill mb-3 fw-bold" id="examTabs" role="tablist">
            @if (listeningData.Any())
            {
                <li class="nav-item"><button class="nav-link active" id="tab-listening" data-bs-toggle="tab" data-bs-target="#content-listening" type="button"><i class="fa fa-headphones"></i> NGHE (@listeningData.Sum(g => g.Count()))</button></li>
            }
            @if (readingData.Any())
            {
                <li class="nav-item"><button class="nav-link @(!listeningData.Any() ? "active" : "")" id="tab-reading" data-bs-toggle="tab" data-bs-target="#content-reading" type="button"><i class="fa fa-book"></i> ĐỌC (@readingData.Sum(g => g.Count()))</button></li>
            }
            @if (writingData.Any())
            {
                <li class="nav-item"><button class="nav-link" id="tab-writing" data-bs-toggle="tab" data-bs-target="#content-writing" type="button"><i class="fa fa-pencil"></i> VIẾT (@writingData.Count)</button></li>
            }
            @if (speakingData.Any())
            {
                <li class="nav-item"><button class="nav-link" id="tab-speaking" data-bs-toggle="tab" data-bs-target="#content-speaking" type="button"><i class="fa fa-microphone"></i> NÓI (@speakingData.Count)</button></li>
            }
        </ul>

        @* --- NỘI DUNG TABS --- *@
        <div class="tab-content" id="examTabContent">

            @* 1. PHẦN NGHE *@
            <div class="tab-pane fade show active" id="content-listening" role="tabpanel">
                @foreach (var group in listeningData)
                {
                    var resource = group.First().ListeningResource;
                    <div class="card mb-4 shadow-sm border-info">
                        <div class="card-header bg-info text-white">
                            <i class="fa fa-play-circle"></i> Bài nghe: <strong>@(resource?.Title)</strong>
                        </div>
                        <div class="card-body">
                            @if (resource != null)
                            {
                                <div class="audio-player mb-4 text-center sticky-top bg-white p-2 border-bottom" style="top: 60px;">
                                    <audio controls src="@resource.AudioUrl" class="w-75"></audio>
                                </div>
                            }
                            <div class="questions-list">
                                @foreach (var q in group)
                                {
                                    globalStt++;
                                    await RenderQuestionItem(q, globalStt);
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>

            @* 2. PHẦN ĐỌC (Chia đôi màn hình: Trái văn bản - Phải câu hỏi) *@
            <div class="tab-pane fade @(!listeningData.Any() ? "show active" : "")" id="content-reading" role="tabpanel">
                @foreach (var group in readingData)
                {
                    var passage = group.First().ReadingPassage;
                    <div class="card mb-4 shadow-sm border-warning">
                        <div class="card-header bg-warning text-dark fw-bold">
                            <i class="fa fa-book-open"></i> Bài đọc: @(passage?.Title)
                        </div>
                        <div class="card-body p-0">
                            <div class="row g-0">
                                @* Cột trái: Văn bản *@
                                <div class="col-lg-6 border-end bg-light">
                                    <div class="p-4" style="height: 500px; overflow-y: auto; text-align: justify; white-space: pre-line; font-family: 'Times New Roman', serif; font-size: 1.1rem;">
                                        @Html.Raw(passage?.Content ?? "Chưa có nội dung")
                                    </div>
                                </div>
                                @* Cột phải: Câu hỏi *@
                                <div class="col-lg-6">
                                    <div class="p-4" style="height: 500px; overflow-y: auto;">
                                        @foreach (var q in group)
                                        {
                                            globalStt++;
                                            await RenderQuestionItem(q, globalStt);
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            @* 3. PHẦN VIẾT *@
            <div class="tab-pane fade" id="content-writing" role="tabpanel">
                @foreach (var q in writingData)
                {
                    globalStt++;
                    <div class="card mb-4 border-success shadow-sm">
                        <div class="card-header bg-success text-white fw-bold">
                            <i class="fa fa-pen"></i> Task Viết số @(writingData.IndexOf(q) + 1) (Câu @globalStt)
                        </div>
                        <div class="card-body">
                            <div class="alert alert-secondary fw-bold">
                                @Html.Raw(q.Content.Replace("\n", "<br>"))
                            </div>
                            <textarea name="userAnswers[@q.Id]" class="form-control" rows="10" placeholder="Nhập bài viết của bạn tại đây..."></textarea>
                        </div>
                    </div>
                }
            </div>

            @* 4. PHẦN NÓI *@
            <div class="tab-pane fade" id="content-speaking" role="tabpanel">
                @foreach (var q in speakingData)
                {
                    globalStt++;
                    <div class="card mb-4 border-danger shadow-sm">
                        <div class="card-header bg-danger text-white fw-bold">
                            <i class="fa fa-microphone"></i> Task Nói số @(speakingData.IndexOf(q) + 1) (Câu @globalStt)
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5 class="fw-bold">Chủ đề / Câu hỏi:</h5>
                                    <p class="fs-5">@q.Content</p>
                                    @if (!string.IsNullOrEmpty(q.MediaUrl))
                                    {
                                        <div class="mt-3">
                                            <img src="@q.MediaUrl" class="img-fluid rounded shadow-sm" style="max-height: 300px;" alt="Speaking prompt" />
                                        </div>
                                    }
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Câu trả lời của bạn:</label>
                                    <textarea name="userAnswers[@q.Id]" class="form-control mb-2" rows="5" placeholder="Ghi chú câu trả lời hoặc link file ghi âm..."></textarea>
                                    <div class="alert alert-warning small">
                                        <i class="fa fa-info-circle"></i> Trong phiên bản thật, hệ thống sẽ hỗ trợ ghi âm trực tiếp tại đây. Hiện tại vui lòng nhập text.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

        </div>

        @* NÚT NỘP BÀI (Floating Button hoặc Cố định dưới cùng) *@
        <div class="fixed-bottom bg-white border-top p-3 text-end shadow-lg" style="z-index: 1050;">
            <span class="me-3 text-muted">Đã hoàn thành <span id="completedCount">0</span>/@globalStt câu</span>
            <button type="submit" class="btn btn-primary btn-lg px-5" onclick="return confirm('Bạn có chắc chắn muốn nộp bài không?')">
                <i class="fa fa-paper-plane"></i> NỘP BÀI
            </button>
        </div>
        <div style="height: 80px;"></div> @* Spacer cho footer *@

    </form>
</div>

@* --- HELPER FUNCTION: RENDER CÂU HỎI TRẮC NGHIỆM --- *@
@functions {
    public async Task RenderQuestionItem(ExamSystem.Core.Entities.Question q, int index)
    {
        <div class="question-box mb-4 p-3 rounded border bg-white" id="q-@q.Id">
            <div class="d-flex">
                <span class="badge bg-secondary me-2 h-100" style="min-width: 30px;">@index</span>
                <div class="flex-grow-1">
                    <p class="fw-bold mb-2">@q.Content</p>

                    @if (q.Answers != null && q.Answers.Any())
                    {
                        <div class="row g-2">
                            @foreach (var ans in q.Answers.OrderBy(a => a.Id))
                            {
                                <div class="col-12">
                                    <div class="form-check p-2 border rounded hover-bg-light">
                                        <input class="form-check-input ms-1 answer-radio" type="radio"
                                               name="userAnswers[@q.Id]" value="@ans.Content"
                                               id="ans_@ans.Id" onchange="updateProgress()">
                                        <label class="form-check-label ms-2 w-100 cursor-pointer" for="ans_@ans.Id">
                                            @ans.Content
                                        </label>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    }
}

<script>
    // 1. Timer Logic
    var duration = @ViewBag.Duration; // Phút
    var timer = duration * 60;
    var timerElement = document.getElementById('timer');

    var interval = setInterval(function () {
        var m = Math.floor(timer / 60);
        var s = timer % 60;
        timerElement.innerText = (m < 10 ? "0" : "") + m + ":" + (s < 10 ? "0" : "") + s;

        // Cảnh báo khi còn dưới 5 phút
        if (timer < 300) timerElement.classList.add("blinking-text");

        if (timer <= 0) {
            clearInterval(interval);
            alert("Hết giờ làm bài!");
            document.getElementById('examForm').submit();
        }
        timer--;
    }, 1000);

    // 2. Cập nhật tiến độ làm bài
    function updateProgress() {
        // Đếm số lượng radio đã được check + textarea có nội dung
        var radioCount = document.querySelectorAll('input[type="radio"]:checked').length;
        var textCount = 0;
        document.querySelectorAll('textarea').forEach(t => {
            if(t.value.trim() !== "") textCount++;
        });

        document.getElementById('completedCount').innerText = radioCount + textCount;
    }

    // 3. CSS Animation cho thời gian sắp hết
    var style = document.createElement('style');
    style.innerHTML = `
        .blinking-text { animation: blinker 1s linear infinite; color: red !important; }
        @@keyframes blinker { 50% { opacity: 0; } }
        .hover-bg-light:hover { background-color: #f8f9fa; border-color: #0d6efd; }
        .cursor-pointer { cursor: pointer; }
    `;
    document.head.appendChild(style);
</script>