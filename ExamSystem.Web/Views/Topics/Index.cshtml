@model IEnumerable<ExamSystem.Core.Entities.Topic>

@{
    ViewData["Title"] = "Quản lý Chủ đề";
}

<div class="container-fluid mt-4">
    @Html.AntiForgeryToken() @* <--- VỊ TRÍ TỐT NHẤT ĐỂ TẠO TOKEN *@
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary m-0"><i class="fa fa-tags"></i> Danh sách Chủ đề</h2>
        <button id="btnAddNewTopic" class="btn btn-success shadow-sm">
            <i class="fa fa-plus-circle"></i> Tạo Chủ đề mới
        </button>
    </div>

    @* === BẢNG DỮ LIỆU === *@
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div id="topicTableContainer" class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                <table id="topicTable" class="table table-striped table-hover align-middle mb-0">
                    <thead class="bg-primary text-white sticky-top">
                        <tr>
                            <th style="width: 5%">ID</th>
                            <th style="width: 25%">Tên Chủ đề</th>
                            <th style="width: 50%">Mô tả chi tiết</th>
                            <th style="width: 20%" class="text-center">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (!Model.Any())
                        {
                            <tr><td colspan="4" class="text-center py-4 text-muted" id="noTopicMessage">Chưa có chủ đề nào được tạo.</td></tr>
                        }

                        @foreach (var item in Model)
                        {
                            <tr data-id="@item.Id">
                                <td><span class="badge bg-secondary">@item.Id</span></td>
                                <td>
                                    <input type="text" class="form-control form-control-sm topic-name" value="@item.Name" required />
                                </td>
                                <td>
                                    <textarea class="form-control form-control-sm topic-description" rows="1">@item.Description</textarea>
                                </td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-warning btn-save" data-id="@item.Id" title="Lưu thay đổi"><i class="fa fa-save"></i> Lưu</button>
                                    <button class="btn btn-sm btn-danger btn-delete" data-id="@item.Id" title="Xóa chủ đề"><i class="fa fa-trash"></i> Xóa</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Html.AntiForgeryToken()
    <script>
        $(document).ready(function () {

            var antiForgeryToken = $('input[name="__RequestVerificationToken"]').val();

            // --- HÀM TẠO DÒNG MỚI (FOR CREATE) ---
            $('#btnAddNewTopic').on('click', function () {
                $('#noTopicMessage').remove();

                if ($('#topicTable tbody tr.new-row').length > 0) {
                    $('#topicTable tbody tr.new-row').find('.topic-name').focus();
                    return;
                }

                var newRow = `
                    <tr class="new-row bg-light" data-id="0">
                        <td><span class="badge bg-secondary">NEW</span></td>
                        <td>
                            <input type="text" class="form-control form-control-sm topic-name" value="" placeholder="Tên chủ đề..." required />
                        </td>
                        <td>
                            <textarea class="form-control form-control-sm topic-description" rows="1" placeholder="Mô tả..."></textarea>
                        </td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-success btn-save-new" title="Tạo mới"><i class="fa fa-plus"></i> Thêm</button>
                            <button class="btn btn-sm btn-secondary btn-cancel-new" title="Hủy bỏ"><i class="fa fa-times"></i> Hủy</button>
                        </td>
                    </tr>
                `;
                $('#topicTable tbody').append(newRow);
                $('#topicTable tbody tr:last-child').find('.topic-name').focus();
            });

            // --- HÀM XỬ LÝ LƯU (EDIT & CREATE) ---

            // Lưu Chủ đề đã tồn tại (Update)
            $(document).on('click', '.btn-save', function () {
                var row = $(this).closest('tr');
                var id = row.data('id');
                var name = row.find('.topic-name').val();
                var description = row.find('.topic-description').val();

                if (!name) {
                    alert('Tên chủ đề không được để trống.');
                    row.find('.topic-name').focus();
                    return;
                }

                if (!confirm(`Xác nhận cập nhật chủ đề #${id} - "${name}"?`)) return;

                $.ajax({
                    url: '/Topics/Edit/' + id,
                    type: 'POST',
                    data: {
                        id: id,
                        name: name,
                        description: description,
                        "__RequestVerificationToken": antiForgeryToken
                    },
                    success: function (result) {
                        if (result.success) {
                            alert('Cập nhật thành công!');
                            row.addClass('table-success').delay(1000).queue(function(next){
                                $(this).removeClass('table-success');
                                next();
                            });
                        } else {
                            alert('Lỗi cập nhật: ' + result.message);
                        }
                    },
                    error: function (xhr) {
                        alert('Lỗi kết nối hoặc xử lý phía Server.');
                    }
                });
            });

            // Tạo Chủ đề mới (Create) - ĐÃ SỬA THỨ TỰ NÚT
            $(document).on('click', '.btn-save-new', function () {
                var row = $(this).closest('tr');
                var name = row.find('.topic-name').val();
                var description = row.find('.topic-description').val();

                if (!name) {
                    alert('Tên chủ đề không được để trống.');
                    row.find('.topic-name').focus();
                    return;
                }

                $.ajax({
                    url: '/Topics/Create',
                    type: 'POST',
                    data: {
                        name: name,
                        description: description,
                        "__RequestVerificationToken": antiForgeryToken
                    },
                    success: function (result) {
                        if (result.success) {
                            alert('Tạo chủ đề mới thành công!');
                            var newId = result.id;
                            row.removeClass('new-row bg-light').attr('data-id', newId);
                            row.find('td:first-child span').text(newId);

                            // 1. Chuyển nút 'Thêm' thành nút 'Lưu' (Giữ vị trí)
                            row.find('.btn-save-new').removeClass('btn-success btn-save-new').addClass('btn-warning btn-save').html('<i class="fa fa-save"></i> Lưu');

                            // 2. Xóa nút 'Hủy'
                            row.find('.btn-cancel-new').remove();

                            // 3. THÊM NÚT XÓA SAU NÚT LƯU VỪA CHUYỂN ĐỔI (Sử dụng ms-2 để tạo khoảng cách)
                            row.find('.text-center').append('<button class="btn btn-sm btn-danger btn-delete ms-2" data-id="' + newId + '" title="Xóa chủ đề"><i class="fa fa-trash"></i> Xóa</button>');

                        } else {
                            alert('Lỗi tạo mới: ' + (result.message || 'Kiểm tra lại dữ liệu nhập.'));
                        }
                    },
                    error: function (xhr) {
                        alert('Lỗi kết nối hoặc xử lý phía Server.');
                    }
                });
            });

            // Hủy tạo mới
            $(document).on('click', '.btn-cancel-new', function () {
                $(this).closest('tr').remove();
                if ($('#topicTable tbody tr').length === 0) {
                     $('#topicTable tbody').append('<tr id="noTopicMessage"><td colspan="4" class="text-center py-4 text-muted">Chưa có chủ đề nào được tạo.</td></tr>');
                }
            });

            // --- HÀM XỬ LÝ XÓA ---
            $(document).on('click', '.btn-delete', function () {
                var id = $(this).data('id');
                var name = $(this).closest('tr').find('.topic-name').val();

                if (!confirm(`CẢNH BÁO: Bạn có chắc chắn muốn xóa chủ đề #${id} - "${name}"?`)) {
                    return;
                }

                var row = $(this).closest('tr');

                $.ajax({
                    url: '/Topics/DeleteConfirmed/' + id,
                    type: 'POST',
                    data: { id: id, "__RequestVerificationToken": antiForgeryToken },
                    success: function (result) {
                        if (result.success) {
                            alert('Xóa chủ đề thành công!');
                            row.fadeOut(300, function() {
                                $(this).remove();
                                if ($('#topicTable tbody tr').length === 0) {
                                    $('#topicTable tbody').append('<tr id="noTopicMessage"><td colspan="4" class="text-center py-4 text-muted">Chưa có chủ đề nào được tạo.</td></tr>');
                                }
                            });
                        } else {
                            alert('Lỗi xóa: ' + result.message);
                        }
                    },
                    error: function (xhr) {
                        alert('Lỗi kết nối hoặc xử lý phía Server.');
                    }
                });
            });
        });
    </script>
}